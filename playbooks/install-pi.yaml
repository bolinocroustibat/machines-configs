- name: Add SSH keys
  hosts: pi-bolino
  tasks:
    - name: Configure SSH keys and settings
      include_role:
        name: ssh
        tasks_from: install

    - name: Configure AllowUsers
      include_role:
        name: ssh
        tasks_from: sshd_allow_users

- name: Set hostname (when prompt_hostname is defined in host_vars)
  hosts: pi-bolino
  become: true
  tasks:
    - name: Set system hostname
      ansible.builtin.hostname:
        name: "{{ prompt_hostname }}"
      when: prompt_hostname is defined and prompt_hostname | length > 0

    - name: Ensure hostname resolves in /etc/hosts (127.0.1.1)
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: "127.0.1.1 {{ prompt_hostname }}"
        insertafter: '^127\.0\.0\.1\s+localhost'
        state: present
      when: prompt_hostname is defined and prompt_hostname | length > 0

- name: Update apt and upgrade packages
  hosts: pi-bolino
  tasks:
    - name: Upgrade all packages
      include_role:
        name: apt
        tasks_from: upgrade

- name: Install Git
  hosts: pi-bolino
  tasks:
    - name: Install Git
      include_role:
        name: git
        tasks_from: install

- name: Configure .bashrc
  hosts: pi-bolino
  tasks:
    - name: Configure bash environment
      include_role:
        name: bash
        tasks_from: install

- name: Install zsh
  hosts: pi-bolino
  tasks:
    - name: Install and configure zsh shell
      include_role:
        name: zsh
        tasks_from: install

- name: Install and configure Starship
  hosts: pi-bolino
  tasks:
    - name: Install Starship prompt
      include_role:
        name: starship
        tasks_from: install

- name: Install and configure fail2ban
  hosts: pi-bolino
  tasks:
    - name: Set up fail2ban intrusion prevention
      include_role:
        name: fail2ban
        tasks_from: install

- name: Install and configure UFW
  hosts: pi-bolino
  tasks:
    - name: Install UFW
      include_role:
        name: ufw
        tasks_from: install

    - name: Configure UFW rules
      include_role:
        name: ufw
        tasks_from: rules

- name: Install and configure Micro
  hosts: pi-bolino
  tasks:
    - name: Install Micro editor
      include_role:
        name: micro
        tasks_from: install

- name: Install bat
  hosts: pi-bolino
  become: true
  tasks:
    - name: Install bat command-line tool
      include_role:
        name: bat

- name: Install and configure uv
  hosts: pi-bolino
  tasks:
    - name: Install uv package manager
      include_role:
        name: uv
        tasks_from: install

- name: Install and configure direnv
  hosts: pi-bolino
  tasks:
    - name: Install and configure direnv
      include_role:
        name: direnv
        tasks_from: install

- name: Install and configure Nginx
  hosts: pi-bolino
  tasks:
    - name: Install and configure Nginx web server
      include_role:
        name: nginx
        tasks_from: install
    - name: Backup Nginx virtual hosts configuration
      include_role:
        name: nginx
        tasks_from: backup_vhosts

- name: Install Certbot
  hosts: pi-bolino
  tasks:
    - name: Install Certbot and Nginx plugin
      include_role:
        name: certbot
        tasks_from: install

- name: Setup storage media disk
  hosts: pi-bolino
  tasks:
    - name: Setup storage media disk mount and directories
      include_role:
        name: storage-media
        tasks_from: main

- name: Install transmission-daemon
  hosts: pi-bolino
  tags: transmission
  tasks:
    - name: Install and run transmission-daemon
      include_role:
        name: transmission
        tasks_from: install
    - name: Configure UFW rules for Transmission
      include_role:
        name: transmission
        tasks_from: ufw
    - name: Configure Transmission web server (Nginx + Certbot)
      include_role:
        name: transmission
        tasks_from: web

- name: Install gdrive upload
  hosts: pi-bolino
  tasks:
    - name: Install rclone and deploy upload script
      include_role:
        name: gdrive
        tasks_from: upload
