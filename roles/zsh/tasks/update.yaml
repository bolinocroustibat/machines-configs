- name: Update ZSH
  block:
    - name: Update ZSH with homebrew
      when: ansible_facts["os_family"] == "Darwin"
      homebrew:
        name: zsh
        state: latest
        update_homebrew: true

    - name: Update ZSH with apt
      when: ansible_facts["os_family"] == "Debian"
      apt:
        name: zsh
        state: latest
        update_cache: true
      become: true

# On macOS, update plugins system-wide via Homebrew
- name: Update ZSH plugins with Homebrew
  when: ansible_facts["os_family"] == "Darwin"
  homebrew:
    name:
      - zsh-autosuggestions
      - zsh-syntax-highlighting
    state: latest
    update_homebrew: true

# Per-user configuration: plugins (Debian), .zshrc, and shell change
- name: Configure ZSH for users
  include_tasks: configure_user.yaml
  loop: "{{ shell_users_list }}"
  loop_control:
    loop_var: user_config
