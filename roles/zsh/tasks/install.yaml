# System-level ZSH installation, then per-user configuration.

- name: Install ZSH
  block:
    - name: Install ZSH with homebrew
      when: ansible_facts["os_family"] == "Darwin"
      homebrew:
        name: zsh
        state: present

    - name: Install ZSH with apt
      when: ansible_facts["os_family"] == "Debian"
      apt:
        name: zsh
        state: present
        update_cache: true
      become: true

- name: Install git (required for ZSH plugins)
  when: ansible_facts["os_family"] == "Debian"
  apt:
    name: git
    state: present
    update_cache: true
  become: true

# On macOS, plugins are installed system-wide via Homebrew
- name: Install ZSH plugins with Homebrew
  when: ansible_facts["os_family"] == "Darwin"
  homebrew:
    name:
      - zsh-autosuggestions
      - zsh-syntax-highlighting
    state: present

# Per-user configuration: plugins (Debian), .zshrc, and shell change
- name: Configure ZSH for users
  include_tasks: configure_user.yaml
  loop: "{{ shell_users_list }}"
  loop_control:
    loop_var: user_config
