- name: Install dnsutils for DNS checks
  apt:
    name: dnsutils
    state: present
    update_cache: true
  become: true

- name: Check if DNS is properly configured
  command: dig +short {{ transmission_domain }}
  register: transmission_dns_check
  changed_when: false
  failed_when: transmission_dns_check.stdout == ""
  become: true

- name: Check if SSL certificate exists
  stat:
    path: "/etc/letsencrypt/live/{{ transmission_domain }}/fullchain.pem"
  register: transmission_ssl_cert_exists
  become: true

- name: Deploy Nginx vhost for Transmission (only if SSL doesn't exist)
  template:
    src: transmission_vhost.conf.j2
    dest: "/etc/nginx/sites-available/{{ transmission_domain }}.conf"
    mode: u=rw,g=r,o=r  # 644
  notify: Reload nginx config
  when: not transmission_ssl_cert_exists.stat.exists
  become: true

- name: Enable Nginx vhost for Transmission (only if SSL doesn't exist)
  file:
    src: "/etc/nginx/sites-available/{{ transmission_domain }}.conf"
    dest: "/etc/nginx/sites-enabled/{{ transmission_domain }}.conf"
    state: link
    force: true
  notify: Reload nginx config
  when: not transmission_ssl_cert_exists.stat.exists
  become: true

- name: Configure SSL with Certbot (only if SSL doesn't exist)
  command: certbot --nginx -d {{ transmission_domain }} --non-interactive --agree-tos --email me@adriencarpentier.com
  args:
    creates: "/etc/letsencrypt/live/{{ transmission_domain }}/fullchain.pem"
  when: transmission_dns_check.stdout != "" and not transmission_ssl_cert_exists.stat.exists
  become: true
  ignore_errors: true
  register: transmission_certbot_result

- name: Display Certbot error if failed
  debug:
    msg: >-
      Certbot failed. Check DNS configuration and firewall rules
      (HTTP port 80 must be open). Error: {{ transmission_certbot_result.stderr_lines | default(['Unknown error']) }}
  when: transmission_certbot_result.rc is defined and transmission_certbot_result.rc != 0
