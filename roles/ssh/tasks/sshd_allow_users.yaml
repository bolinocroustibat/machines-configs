# Deploy AllowUsers: connection user (ansible_user) plus ssh__allow_users.
# Override ssh__allow_users in host_vars to add more users. Requires root to write and restart ssh.

- name: Ensure sshd_config.d exists
  ansible.builtin.file:
    path: /etc/ssh/sshd_config.d
    state: directory
    mode: u=rwx,g=rx,o=rx  # 755
  become: true

- name: Deploy AllowUsers drop-in
  ansible.builtin.copy:
    dest: /etc/ssh/sshd_config.d/99-allow-users.conf
    content: "AllowUsers {{ ([ansible_user] + (ssh__allow_users | default([]))) | unique | join(' ') }}\n"
    mode: u=rw,g=r,o=r  # 644
  register: ssh_allow_users_file
  become: true

- name: Restart ssh so AllowUsers takes effect
  ansible.builtin.service:
    name: ssh
    state: restarted
  when: ssh_allow_users_file is changed
  become: true
