- name: Add the GitHub Actions user with a specific uid and add it to the 'www-data' group
  user:
    name: "{{ github_actions__user_name }}"
    state: present
    comment: user used by GitHub Actions runner for deploying tasks
    create_home: true
    uid: 1002
    groups: www-data,docker
    append: true

- name: Add '.ssh' directory
  file:
    path: "/home/{{ github_actions__user_name }}/.ssh"
    state: directory
    owner: "{{ github_actions__user_name }}"
    group: "{{ github_actions__user_name }}"
    mode: u=rwx,g=,o= # 700 (only owner has read, write, and execute permissions)

- name: Add the GitHub Actions user public key to '.ssh' directory
  template:
    src: id_rsa.pub
    dest: "/home/{{ github_actions__user_name }}/.ssh/id_rsa.pub"
    owner: "{{ github_actions__user_name }}"
    group: "{{ github_actions__user_name }}"
    mode: u=rw,g=r,o=r # 644 (read access for everyone and also write access for the owner of the file)

- name: Add the GitHub Actions user public key to 'authorized_keys' file
  authorized_key:
    user: "{{ github_actions__user_name }}"
    state: present
    key: "{{ lookup('file', '/home/{{ github_actions__user_name }}/.ssh/id_rsa.pub') }}"
  register: github_actions_auth_key_result
  failed_when:
    - github_actions_auth_key_result.failed
    - "'No such file or directory' not in github_actions_auth_key_result.msg"

# If this role runs, add the user to AllowUsers so the runner can connect via SSH.
- name: Check if AllowUsers config exists
  ansible.builtin.stat:
    path: /etc/ssh/sshd_config.d/99-allow-users.conf
  register: _allow_users_stat

- name: Read current AllowUsers config
  ansible.builtin.slurp:
    src: /etc/ssh/sshd_config.d/99-allow-users.conf
  register: _allow_users_file
  when: _allow_users_stat.stat.exists | default(false) | bool

- name: Add GitHub Actions user to AllowUsers
  ansible.builtin.replace:
    path: /etc/ssh/sshd_config.d/99-allow-users.conf
    regexp: '^(\s*AllowUsers\s+)(.*)$'
    replace: '\1\2 {{ github_actions__user_name }}'
  register: _allow_users_updated
  when:
    - _allow_users_stat.stat.exists | default(false) | bool
    - _allow_users_file.content is defined
    - github_actions__user_name not in (_allow_users_file.content | b64decode | trim)

- name: Restart ssh after adding user to AllowUsers
  ansible.builtin.service:
    name: ssh
    state: restarted
  when: _allow_users_updated is changed | default(false) | bool
