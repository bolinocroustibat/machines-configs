- name: Load this role secrets
  include_vars:
    file: "{{ role_path }}/vars/secrets.yaml"
  ignore_errors: true

- name: Load postgres role secrets (same vars as postgres role)
  include_vars:
    file: "{{ playbook_dir }}/../roles/postgres/vars/secrets.yaml"
  ignore_errors: true

- name: Git clone databases backup script (public repo, HTTPS)
  git:
    repo: https://github.com/bolinocroustibat/databases-backup-over-scp.git
    dest: "{{ user_home }}/databases-backup-over-scp"
    update: true

- name: Create virtualenv and install requirements
  command: uv sync
  args:
    chdir: "{{ user_home }}/databases-backup-over-scp"

- name: Add settings
  template:
    src: settings.py.j2
    dest: "{{ user_home }}/databases-backup-over-scp/settings.py"

- name: Ensure local backup directory exists and is owned by local user
  file:
    path: "{{ databases_backup_over_scp__local_backup_path }}"
    state: directory
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_id }}"
    mode: u=rwx,g=rwx,o= # 770
  become: true

- name: Make the main script executable by current user
  command: "chmod +x {{ user_home }}/databases-backup-over-scp/main.py"

- name: Remove existing backup cron job (so it can be re-added with current config)
  cron:
    name: "databases_backup_over_scp"
    state: absent

- name: Add cron job to execute the backup script
  cron:
    name: "databases_backup_over_scp"
    minute: "0"
    hour: "4"
    day: "*"
    job: "uv run {{ user_home }}/databases-backup-over-scp/main.py >> {{ user_home }}/databases-backup-over-scp/logs/cron_{{ ansible_facts['date_time']['iso8601'] }}.log"
