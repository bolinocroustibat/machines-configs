#!/bin/bash

# Configuration
LOCAL_DIR="{{ upload_gdrive_local_dir }}"
REMOTE_NAME="{{ upload_gdrive_remote_name }}"
REMOTE_DIR="{{ upload_gdrive_remote_dir }}"

# When called by Transmission (script-torrent-done), use only the finished torrent dir
# Otherwise (manual run) upload the whole local dir
if [[ -n "${TR_TORRENT_DIR:-}" ]]; then
    UPLOAD_SRC="$TR_TORRENT_DIR"
    echo "Uploading finished torrent: $TR_TORRENT_NAME (${TR_TORRENT_DIR})"
else
    UPLOAD_SRC="$LOCAL_DIR"
    echo "Uploading full directory: $UPLOAD_SRC"
fi

# Using 'move' to free space on the Pi; use 'copy' if you want to keep a local copy
# --stats 60s: progress logged once per minute per transfer (use 5s for verbose)
echo "Starting upload to Google Drive..."

rclone move "$UPLOAD_SRC" "$REMOTE_NAME:$REMOTE_DIR" \
    --transfers 4 \
    --checkers 8 \
    --exclude "*.part" \
    --log-file {{ upload_gdrive_log_file }} \
    --log-level INFO \
    --stats 60s \
    --stats-one-line \
    --delete-empty-src-dirs

if [[ -n "${TR_TORRENT_DIR:-}" ]]; then
    echo "Upload finished: $TR_TORRENT_NAME -> $REMOTE_NAME:$REMOTE_DIR"
else
    echo "Upload finished: $UPLOAD_SRC -> $REMOTE_NAME:$REMOTE_DIR"
fi
